<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elm + Parcel App</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div id="root"></div>

    <!-- Load piano instrument data from CDN -->
    <script src='https://surikov.github.io/webaudiofontdata/sound/0250_SoundBlasterOld_sf2.js'></script>

    <!-- Load WebAudioFont player from CDN -->
    <script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>

    <script type="module">
        import { Elm } from "./Main.elm";

        // Capture globals as clean constants
        const WebAudioFontPlayer = window.WebAudioFontPlayer;
        const piano = window._tone_0250_SoundBlasterOld_sf2;

        // Initialize Elm
        const app = Elm.Main.init({ node: document.getElementById("root") });

        // Initialize WebAudioFont
        const audioContext = new AudioContext();
        const player = new WebAudioFontPlayer();

        // Use the captured constants
        player.loader.decodeAfterLoading(audioContext, piano);

        // Start high-frequency time sync to Elm
        setInterval(() => {
            app.ports.timeSync.send(audioContext.currentTime);
        }, 10); // 100Hz updates

        // Listen to Elm port commands
        app.ports.playNote.subscribe((noteData) => {
            const { note, duration, volume } = noteData;
            player.queueWaveTable(audioContext, audioContext.destination,
                piano, 0, note, duration, volume);
        });

        // Listen to sequence playback commands
        app.ports.playSequence.subscribe((sequence) => {
            // Cancel any currently playing sequences
            player.cancelQueue(audioContext);

            const currentTime = audioContext.currentTime;

            // Schedule each note in the sequence
            sequence.forEach((noteData) => {
                const { note, startTime, duration, volume } = noteData;
                const scheduledTime = currentTime + startTime;

                player.queueWaveTable(audioContext, audioContext.destination,
                    piano, scheduledTime, note, duration, volume);
            });
        });

        // Listen to real-time note scheduling
        app.ports.scheduleNote.subscribe((noteData) => {
            const { note, absoluteTime, duration, volume } = noteData;
            player.queueWaveTable(audioContext, audioContext.destination,
                piano, absoluteTime, note, duration, volume);
        });

        // Wake audio context on user interaction
        app.ports.wakeAudioContext.subscribe(() => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>

