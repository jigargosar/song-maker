<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Maker V2</title>
    <link rel="stylesheet" href="./styles2.css">
</head>
<body>
<div id="root"></div>

<!-- Load piano instrument data from CDN -->
<script src='https://surikov.github.io/webaudiofontdata/sound/0250_SoundBlasterOld_sf2.js'></script>

<!-- Load individual drum sounds from CDN -->
<script src='https://surikov.github.io/webaudiofontdata/sound/12836_0_SBLive_sf2.js'></script>
<script src='https://surikov.github.io/webaudiofontdata/sound/12838_0_SBLive_sf2.js'></script>

<!-- Load WebAudioFont player from CDN -->
<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>

<script type="module">
    import { Elm } from "./Main2.elm";

    // Capture globals as clean constants
    const WebAudioFontPlayer = window.WebAudioFontPlayer;
    const piano = window._tone_0250_SoundBlasterOld_sf2;
    const kickDrum = window._drum_36_0_SBLive_sf2;  // MIDI 36 - Bass Drum 1
    const snareDrum = window._drum_38_0_SBLive_sf2; // MIDI 38 - Snare Drum 1

    // Initialize Elm
    const app = Elm.Main2.init({ node: document.getElementById("root") });

    // Initialize WebAudioFont
    const audioContext = new AudioContext();
    const player = new WebAudioFontPlayer();

    // Use the captured constants
    player.loader.decodeAfterLoading(audioContext, piano);
    player.loader.decodeAfterLoading(audioContext, kickDrum);
    player.loader.decodeAfterLoading(audioContext, snareDrum);

    // Handle individual note playback
    app.ports.playNote.subscribe((data) => {
        const { note, duration, volume } = data;
        const when = audioContext.currentTime;

        player.queueWaveTable(
            audioContext,
            audioContext.destination,
            piano,
            when,
            note,
            duration,
            volume
        );
    });

    // Handle percussion playback
    app.ports.playPercussion.subscribe((data) => {
        const { note, duration, volume } = data;
        const when = audioContext.currentTime;

        // Select correct drum based on MIDI note
        const drumInstrument = note === 36 ? kickDrum : snareDrum;

        player.queueWaveTable(
            audioContext,
            audioContext.destination,
            drumInstrument,
            when,
            note,
            duration,
            volume
        );
    });

    // Wake audio context on user interaction
    // app.ports.wakeAudioContext.subscribe(() => {
    //     if (audioContext.state === 'suspended') {
    //         audioContext.resume();
    //     }
    // });

    // Wake audio context on first click
    document.addEventListener('click', () => {
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    }, { once: true });
</script>
</body>
</html>
