<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Maker V2</title>
    <link rel="stylesheet" href="./styles2.css">
</head>
<body>
<div id="root"></div>

<!-- Load piano instrument data from CDN -->
<script src='https://surikov.github.io/webaudiofontdata/sound/0250_SoundBlasterOld_sf2.js'></script>

<!-- Load individual percussion sounds from CDN -->
<script src='https://surikov.github.io/webaudiofontdata/sound/12836_0_SBLive_sf2.js'></script>
<script src='https://surikov.github.io/webaudiofontdata/sound/12838_0_SBLive_sf2.js'></script>

<script src='https://surikov.github.io/webaudiofontdata/sound/0110_SBLive_sf2.js'></script>

<!-- Load WebAudioFont player from CDN -->
<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>

<script type="module">
    import { Elm } from "./Main2.elm";

    // Capture globals as clean constants
    const WebAudioFontPlayer = window.WebAudioFontPlayer;
    const piano = window._tone_0250_SoundBlasterOld_sf2;
    const marimba = window._tone_0110_SBLive_sf2

    // Percussion kit configuration
    const percussionKit = {
        36: window._drum_36_0_SBLive_sf2,  // Kick
        38: window._drum_38_0_SBLive_sf2   // Snare
    };

    // Initialize Elm
    const app = Elm.Main2.init({ node: document.getElementById("root") });

    // Initialize WebAudioFont
    const audioContext = new AudioContext();
    const player = new WebAudioFontPlayer();

    // const WebAudioFontLoader = window.WebAudioFontLoader;
    // const loader = new WebAudioFontLoader(player);
    // console.log( loader.instrumentInfo(11), loader.findInstrument(11) );


    // Load instruments
    player.loader.decodeAfterLoading(audioContext, piano);
    Object.values(percussionKit).forEach(instrument => {
        player.loader.decodeAfterLoading(audioContext, instrument);
    });

    // Handle unified note playback
    app.ports.playNote.subscribe((data) => {
        const { instrument, midi, duration, volume } = data;
        const when = audioContext.currentTime;

        // Look up instrument by name from window object
        const instrumentSample = window[instrument];

        if (instrumentSample) {
            player.queueWaveTable(
                audioContext,
                audioContext.destination,
                instrumentSample,
                when,
                midi,
                duration,
                volume
            );
        } else {
            console.warn(`Instrument not found: ${instrument}`);
        }
    });

    // Send timeSync updates using setInterval (works in background)
    setInterval(() => {
        if (app.ports.timeSync) {
            app.ports.timeSync.send(audioContext.currentTime);
        }
    }, 16); // ~60fps

    // Wake audio context on first click
    document.addEventListener('click', () => {
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    }, { once: true });
</script>
</body>
</html>
